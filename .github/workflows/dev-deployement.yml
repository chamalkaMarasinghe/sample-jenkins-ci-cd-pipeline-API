name: Trigger Jenkins

on:
  push:
    branches:
      - main

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Call Jenkins Build and Deploy Pipeline
        run: |
          CRUMB=$(curl -s \
            -u "${{ vars.JENKINS_USER }}:${{ secrets.JENKINS_API_TOKEN }}" \
            http://20.193.255.237/crumbIssuer/api/json \
            | jq -r '.crumbRequestField + ":" + .crumb')
      
          echo "Crumb fetched: $CRUMB"
      
          curl -X POST \
            -u "${{ vars.JENKINS_USER }}:${{ secrets.JENKINS_API_TOKEN }}" \
            -H "$CRUMB" \
            "http://20.193.255.237/job/Build%20and%20deploy/buildWithParameters" \
            --data-urlencode token=${{ secrets.JENKINS_TRIGGER_SECRET }} \
            --data-urlencode REMOTE_HOST=${{ vars.REMOTE_HOST }} \
            --data-urlencode REMOTE_USER=${{ vars.REMOTE_USER }} \
            --data-urlencode APP_DIR=${{ vars.APP_DIR }} \
            --data-urlencode REPO_URL=${{ vars.REPO_URL }} \
            --data-urlencode BRANCH=${{ vars.BRANCH }} \
            --data-urlencode DOPPLER_PROJECT=${{ vars.DOPPLER_PROJECT }} \
            --data-urlencode DOPPLER_CONFIG=${{ vars.DOPPLER_CONFIG }}
